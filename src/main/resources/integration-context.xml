<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:task="http://www.springframework.org/schema/task"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd   http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd">

    <int:channel id="splitReqCh"/>
    <int:channel id="bridgeCh">
        <int:queue/>
    </int:channel>
    <int:channel id="headerEnricherCh"/>
    <int:channel id="sendCh"/>
    <int:channel id="receiveCh">
        <int:queue capacity="10"/>
    </int:channel>
    <int:channel id="filterHasMoreCh"/>
    <int:channel id="resequencerCh"/>
    <int:channel id="splitResCh"/>
    <int:channel id="outCh"/>
    <int:channel id="filterEmptyCh"/>

    <bean id="objectMapper" class="com.fasterxml.jackson.databind.ObjectMapper"/>

    <bean id="messageProcessor" class="com.example.springintegration.integration.MessageProcessor">
        <constructor-arg name="objectMapper" ref="objectMapper"/>
    </bean>

    <task:executor id="taskExecutor" pool-size="10" queue-capacity="10"/>

    <int:poller id="defaultPoller" default="true" max-messages-per-poll="5" fixed-rate="200"/>

    <int:gateway id="siGateway"
                 default-request-channel="splitReqCh"
                 service-interface="com.example.springintegration.integration.SiGateway"/>

    <int:splitter id="splitRequest" input-channel="splitReqCh" output-channel="bridgeCh"/>

    <int:bridge id="bridge" input-channel="bridgeCh" output-channel="headerEnricherCh">
        <int:poller fixed-delay="200" task-executor="taskExecutor"/>
    </int:bridge>

    <int:enricher id="enrichHeader" input-channel="headerEnricherCh" output-channel="sendCh">
        <int:header name="type" expression="payload"/>
    </int:enricher>

    <int:service-activator id="processMessage" input-channel="receiveCh" output-channel="filterHasMoreCh" ref="messageProcessor"/>

    <int:filter input-channel="filterHasMoreCh" output-channel="resequencerCh" expression="headers.hasMore.equals('false')"/>

    <int:resequencer input-channel="resequencerCh" output-channel="filterEmptyCh" release-partial-sequences="true"/>

    <int:filter input-channel="filterEmptyCh" output-channel="splitResCh" expression="headers.isEmpty.equals('false')" />

    <int:splitter id="splitResponse" input-channel="splitResCh" output-channel="outCh"/>


</beans>